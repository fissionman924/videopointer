/**
 * @license Copyright 2016 Nathaniel Lord
 */
!function(t){"use strict";function e(e,i){return this.each(function(){var n=t(this),r=n.data("videopointer"),a="object"==typeof e&&e;r||n.data("videopointer",r=new o(this,a)),"string"==typeof e&&r[e](i)})}Math.radians=function(t){return t*Math.PI/180};var o=function(t,e){this.$element=null,this.options=null,this.init(t,e)};o.DEFAULTS={initialized:!1,endPointRadius:4,endPointStroke:2,lineColor:"#fff",line:{color:"#fff",width:2,style:"angled",angle:45},endPoint:{radius:0,stroke:0,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},anchorPoint:{radius:0,stroke:0,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},videoSelector:"video",itemSelector:".pointer-item",anchorSelector:".pointer-anchor"},o.prototype.init=function(e,o){var i=this;this.$element=t(e),this.options=this.getOptions(o),this.state={},this.generatePoints.apply(this),this.$element.on("mouseenter focus",i.options.itemSelector,function(e){var o=t(i.options.itemSelector,i.$element).index(e.currentTarget),n=i.options.points[o].time,r=t(i.options.videoSelector,i.$element)[0];return void 0===n?!1:(r.currentTime=n,void(r.paused||r.pause()))}).on("mouseleave blur",i.options.itemSelector,function(e){var o=t(i.options.videoSelector,i.$element)[0];o.paused&&o.play()}),t(window).on("resize",function(t){i.generatePoints.apply(i)}),t(i.options.videoSelector,this.$element).on("canplay",function(t){i.generatePoints.apply(i)})};var i=function(t,e){var o;if(typeof t!=typeof e)return!1;if(null===t||null===e&&t!==e)return!1;if(Array.isArray(t)){if(t.length!=e.length)return!1;for(t.sort(),e.sort(),o=0;o<t.length;o++)if(!i(t[o],e[o]))return!1}else{if("object"!=typeof t)return t===e;var n=Object.keys(t),r=Object.keys(e);if(!i(n,r))return!1;for(o=0;o<n.length;o++)if(!i(t[n[o]],e[r[o]]))return!1}return!0};o.prototype.clearImages=function(){t(".pointer",this.$element).replaceWith("")},o.prototype.rerender=function(){this.state={},this.clearImages.apply(this),this.generatePoints.apply(this)},o.prototype.generatePoints=function(){var e=this,o=(this.options.points,this.options.line.angle),c=!1,y=t(e.options.videoSelector,this.$element),f=a(y),u=[],x=n.apply(this);t(x,this.$element).each(function(e,o){var i=t(o),n=a(i);u.push(n)}),void 0!==e.state.vid&&void 0!==e.state.items&&i(e.state.vid,f)&&i(e.state.items,u)||(e.state.vid=f,e.state.items=u,e.clearImages.apply(e),c=!0),c&&t(x,this.$element).each(function(i,n){var c=e.options.points[i];if(void 0===c)return!1;var y=!1,u={x:0,y:0},x={x:0,y:0},p={x:0,y:0};u.x=c.x/100*f.w+f.x,u.y=c.y/100*f.h+f.y;var m=t(n),v=a(m);l(f,v)?(y=!0,m.position().top>f.y+f.h?x.y=m.offset().top:x.y=m.offset().top+m.outerHeight(),x.x=m.offset().left+m.outerWidth()/2):(m.position().left>f.x+f.w?x.x=m.offset().left:x.x=m.offset().left+m.outerWidth(),x.y=m.offset().top+m.outerHeight()/2);var g=e.options.endPoint.fillColor;void 0!==c.color&&(g=c.color),"straight"===e.options.line.style?t.extend(p,x):p=h(x,u,o,y),d.call(e,c,u,p,x,g,function(t){r.call(e,c,n,x,s(m),u,y,t)})})};var n=function(){var e=this.options.anchorSelector;return 0===t(e,this.$element).length&&(e=this.options.itemSelector),e},r=function(e,o,i,r,a,s,l){var h=this,d=t.extend(!0,{},this.options.endPoint,e.endPoint),c=t.extend(!0,{},this.options.anchorPoint,e.anchorPoint),y=(t.extend(!0,{},this.options.line,e.line),n.apply(this));h.options.itemSelector===y?t(o).append(l):t(o).parents(h.options.itemSelector).append(l),t(l).css("position","absolute");var f=1,u=1;t(l).height()<=12?f=d.radius+d.stroke-Math.abs(i.y-a.y):f+=c.radius,t(l).width()<=12?u=d.radius+d.stroke-Math.abs(i.x-a.x):u+=c.radius;var x={left:0,top:0};s?(a.x>i.x?x.left=r.x:x.left=r.x-l.width,a.y>i.y?x.top=r.y-f:x.top=r.y-l.height+f):(a.x>i.x?x.left=r.x:x.left=r.x-l.width,a.y>i.y?x.top=r.y-f+r.h/2:x.top=r.y-l.height+f+r.h/2),t(l).css({top:x.top+"px",left:x.left+"px"}).addClass("pointer")},a=function(t){var e={x:t.offset().left,y:t.offset().top,w:t.outerWidth(),h:t.outerHeight()};return e},s=function(t){var e={x:t.position().left,y:t.position().top,w:t.outerWidth(),h:t.outerHeight()};return e},l=function(t,e){var o=!1;return e.x>=t.x&&e.x<=t.x+t.w&&(e.y>t.y+t.h||e.y+e.h<t.y)&&(o=!0),o},h=function(t,e,o,i){var n={x:0,y:0},r={A:o,B:90,C:180-o-90},a={a:Math.abs(e.y-t.y),b:0,c:0};return i&&(a.a=Math.abs(e.x-t.x)),a.b=a.a*Math.sin(Math.radians(r.B))/Math.sin(Math.radians(r.A)),a.c=a.a*Math.sin(Math.radians(r.C))/Math.sin(Math.radians(r.A)),i?(e.y>t.y?n.y=e.y-a.c:n.y=e.y+a.c,Math.abs(e.y-t.y)<Math.abs(e.x-t.x)&&(n.y=e.y),n.x=t.x):(e.x>t.x?n.x=e.x-a.c:n.x=e.x+a.c,Math.abs(e.x-t.x)<Math.abs(e.y-t.y)&&(n.x=e.x),n.y=t.y),n},d=function(e,o,i,n,r,a){var s=new Image,l=this,h={anchor:{},mid:{},end:{}},d=n.x===i.x&&n.y!==i.y,f=t.extend(!0,{},this.options.endPoint,e.endPoint),u=t.extend(!0,{},this.options.anchorPoint,e.anchorPoint),m=t.extend(!0,{},this.options.line,e.line),v={w:Math.ceil(Math.abs(n.x-o.x)+f.radius+u.radius+6),h:Math.ceil(Math.abs(o.y-n.y)+f.radius+u.radius+6)},g=document.createElement("canvas");g.height=v.h,g.width=v.w;var M=g.getContext("2d");if(Math.floor(this.options.line.width)%2===1){var b=.5;o.y<n.y&&(b=-.5),M.translate(.5,b)}var k=0;if(Math.abs(n.y-o.y)<=f.radius&&(k=this.options.endPoint.radius+2-Math.abs(n.y-o.y),0>k&&(k=0)),o.x>n.x?(h.anchor.x=1+u.radius,h.mid.x=Math.ceil(i.x-n.x)+h.anchor.x,h.end.x=Math.ceil(o.x-n.x)+h.anchor.x):(h.anchor.x=Math.ceil(v.w-1-u.radius),h.mid.x=h.anchor.x-Math.ceil(n.x-i.x),h.end.x=h.anchor.x-Math.ceil(n.x-o.x)),o.y>n.y?(h.anchor.y=1+u.radius,h.mid.y=Math.ceil(i.y-n.y)+h.anchor.y,h.end.y=Math.ceil(o.y-n.y)+h.anchor.y):n.y>o.y&&(h.anchor.y=Math.ceil(v.h-k-1-u.radius),h.mid.y=h.anchor.y-Math.ceil(n.y-i.y-k),h.end.y=h.anchor.y-Math.ceil(n.y-o.y-k)),"angled"===m.style)p(M,[h.anchor,h.mid,h.end],m.width,m.color);else if("straight"===m.style)p(M,[h.anchor,h.end],m.width,m.color);else if("curved"===m.style){var P=100,w={x:0,y:0},C={x:0,y:0};h.mid.x===h.anchor.x&&h.mid.y===h.end.y?(w.x=h.anchor.x,C.y=h.end.y,P>h.mid.y&&(P=h.mid.y),Math.abs(h.mid.x-h.end.x)<P&&(P=Math.abs(h.mid.x-h.end.x)),h.anchor.y<h.end.y?w.y=h.mid.y-P:w.y=h.mid.y-P,h.anchor.x>h.end.x?C.x=h.mid.x-P:C.x=h.mid.x+P,x(M,[h.anchor,w,C,h.end],m.width,m.color,d)):h.mid.y===h.anchor.y&&h.mid.x===h.end.x?(w.y=h.anchor.y,C.x=h.end.x,P>h.mid.x&&(P=h.mid.x),Math.abs(h.mid.y-h.end.y)<P&&(P=Math.abs(h.mid.y-h.end.y)),h.anchor.x<h.end.x?w.x=h.mid.x-P:w.x=h.mid.x+P,h.anchor.y>h.end.y?C.y=h.mid.y-P:C.y=h.mid.y+P,x(M,[h.anchor,w,C,h.end],m.width,m.color,d)):x(M,[h.anchor,h.mid,h.end],m.width,m.color,d)}c.call(l,M,h.anchor,u,function(){y.call(l,M,h.end,f,function(){s.src=g.toDataURL("image/png"),a(s)})})},c=function(t,e,o,i){"circle"===o.style?m(t,e,o.radius,o.stroke,o.fillColor,o.strokeColor):"square"===o.style&&v(t,e,o.radius,o.stroke,o.fillColor,o.strokeColor),"image"===o.style&&""!==o.url?u(t,e,o.url,o.radius,i):i.call(this)},y=function(t,e,o,i){"circle"===o.style?m(t,e,o.radius,o.stroke,o.fillColor,o.strokeColor):"square"===o.style&&v(t,e,o.radius,o.stroke,o.fillColor,o.strokeColor),"image"===o.style&&""!==o.url?u(t,e,o.url,o.radius,i):i.call(this)},f=function(t){var e=!1,o=document.createElement("canvas"),i=o.getContext("2d");i.drawImage(t,1,1);try{o.toDataURL();e=!0}catch(n){console.log("The image specified for the endpoint is not a valid image for cross origin resource sharing")}return e},u=function(t,e,o,i,n){var r=document.createElement("img");r.src=o,r.crossOrigin="Anonymous",r.onload=function(){f(r)&&t.drawImage(r,e.x,e.y,i,i),n()},r.onerror=function(){console.log("Couldn't load the endpoint image. Please make sure it's hosted on your sire, is a valid cross origin image, is not located in a file path, and is accessible."),n()}},x=function(t,e,o,i,n){t.beginPath(),t.strokeStyle=i,t.lineWidth=o,t.moveTo(e[0].x,e[0].y);for(var r={x:0,y:0},a={x:0,y:0},s={x:0,y:0},l=1;l<e.length;l++)r=e[l],s=e[l-1],n?(a.x=s.x,a.y=r.y):(a.x=r.x,a.y=s.y),t.quadraticCurveTo(a.x,a.y,r.x,r.y);t.stroke()},p=function(t,e,o,i){t.beginPath(),t.strokeStyle=i,t.lineWidth=o,t.moveTo(e[0].x,e[0].y);for(var n,r=1;r<e.length;r++)n=e[r],t.lineTo(n.x,n.y);t.stroke()},m=function(t,e,o,i,n,r){t.beginPath(),t.strokeStyle=r,t.fillStyle=n,t.lineWidth=i,t.arc(e.x,e.y,o,0,2*Math.PI,!1),i>0&&t.stroke(),t.fill()},v=function(t,e,o,i,n,r){t.beginPath(),t.strokeStyle=r,t.fillStyle=n,t.lineWidth=i,i>0&&(t.rect(e.x-o,e.y-o,2*o,2*o),t.stroke()),t.fillRect(e.x-o,e.y-o,2*o,2*o)};o.prototype.getOptions=function(e){var o=t.extend(!0,{},this.getDefaults(),this.$element.data(),e);return o},o.prototype.getDefaults=function(){return o.DEFAULTS},o.prototype.destroy=function(){delete this.options,delete this.$element};var g=t.fn.videopointer;t.fn.videopointer=e,t.fn.videopointer.Constructor=o,t.fn.videopointer.noConflict=function(){return t.fn.videopointer=g,this}}(jQuery);