/**
 * @license Copyright 2016 Nathaniel Lord
 */
!function(t){"use strict";function e(e,i){return this.each(function(){var n=t(this),s=n.data("videopointer"),r="object"==typeof e&&e;s||n.data("videopointer",s=new o(this,r)),"string"==typeof e&&s[e](i)})}Math.radians=function(t){return t*Math.PI/180};var o=function(t,e){this.$element=null,this.options=null,this.init(t,e)};o.DEFAULTS={initialized:!1,endPointRadius:4,endPointStroke:2,lineColor:"#fff",line:{color:"#fff",width:2,style:"angled",angle:45},endPoint:{radius:4,stroke:2,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},anchorPoint:{radius:4,stroke:2,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},videoSelector:"video",itemSelector:".pointer-item",anchorSelector:".pointer-anchor"},o.prototype.init=function(e,o){var i=this;this.$element=t(e),this.options=this.getOptions(o),this.state={},this.generatePoints.apply(this),this.$element.on("mouseenter focus",i.options.itemSelector,function(e){var o=t(i.options.itemSelector,i.$element).index(e.currentTarget),n=i.options.points[o].time,s=t(i.options.videoSelector,i.$element)[0];return void 0===n?!1:(s.currentTime=n,void(s.paused||s.pause()))}).on("mouseleave blur",i.options.itemSelector,function(e){var o=t(i.options.videoSelector,i.$element)[0];o.paused&&o.play()}),t(window).on("resize",function(t){i.generatePoints.apply(i)}),t(i.options.videoSelector,this.$element).on("canplay",function(t){i.generatePoints.apply(i)})};var i=function(t,e){var o;if(typeof t!=typeof e)return!1;if(null===t||null===e&&t!==e)return!1;if(Array.isArray(t)){if(t.length!=e.length)return!1;for(t.sort(),e.sort(),o=0;o<t.length;o++)if(!i(t[o],e[o]))return!1}else{if("object"!=typeof t)return t===e;var n=Object.keys(t),s=Object.keys(e);if(!i(n,s))return!1;for(o=0;o<n.length;o++)if(!i(t[n[o]],e[s[o]]))return!1}return!0};o.prototype.clearImages=function(){t(".pointer",this.$element).replaceWith("")},o.prototype.rerender=function(){this.state={},this.clearImages.apply(this),this.generatePoints.apply(this)},o.prototype.generatePoints=function(){var e=this,o=(this.options.points,this.options.line.angle),s=!1,r=t(e.options.videoSelector,this.$element),a={x:r.position().left,y:r.position().top,w:r.width(),h:r.height()},l=[],h=e.options.anchorSelector;if(0===t(h,this.$element).length&&(h=e.options.itemSelector),t(h,this.$element).each(function(e,o){var i=t(o),n={x:i.position().left,y:i.position().top,w:i.width(),h:i.outerHeight()};l.push(n)}),void 0!==e.state.vid&&void 0!==e.state.items&&i(e.state.vid,a)&&i(e.state.items,l)||(e.state.vid=a,e.state.items=l,e.clearImages.apply(e),s=!0),s){var p;t(h,this.$element).each(function(i,s){var r=e.options.points[i];if(void 0===r)return!1;var l=!1,d={x:0,y:0},y={x:0,y:0},c={x:0,y:0};d.x=r.x/100*a.w+a.x,d.y=r.y/100*a.h+a.y;var f=t(s);f.position().left>=a.x&&f.position().left<=a.x+a.w&&(f.position().top>a.y+a.h||f.position().top+f.outerHeight()<a.y)?(l=!0,f.position().top>a.y+a.h?y.y=f.position().top:y.y=f.position().top+f.outerHeight(),y.x=f.position().left+f.outerWidth()/2):(f.position().left>a.x+a.w?y.x=f.position().left:y.x=f.position().left+f.outerWidth(),y.y=f.position().top+f.outerHeight()/2);var u={A:o,B:90,C:180-o-90},x={a:Math.abs(d.y-y.y),b:0,c:0};l&&(x.a=Math.abs(d.x-y.x)),x.b=x.a*Math.sin(Math.radians(u.B))/Math.sin(Math.radians(u.A)),x.c=x.a*Math.sin(Math.radians(u.C))/Math.sin(Math.radians(u.A)),l?(d.y>y.y?c.y=d.y-x.c:c.y=d.y+x.c,Math.abs(d.y-y.y)<Math.abs(d.x-y.x)&&(c.y=d.y),c.x=y.x):(d.x>y.x?c.x=d.x-x.c:c.x=d.x+x.c,Math.abs(d.x-y.x)<Math.abs(d.y-y.y)&&(c.x=d.x),c.y=y.y);var v=e.options.endPoint.fillColor;void 0!==r.color&&(v=r.color),p=null,p=n.call(e,d,c,y,v),e.options.itemSelector===h?t(s).append(p):t(s).parents(e.options.itemSelector).append(p),t(p).css("position","absolute");var m=1,g=1;t(p).height()<=12&&(m=e.options.endPoint.radius+e.options.endPoint.stroke-Math.abs(y.y-d.y)),t(p).width()<=12&&(g=e.options.endPoint.radius+e.options.endPoint.stroke-Math.abs(y.x-d.x));var M={left:0,top:0};l?(d.x>y.x?M.left=y.x:M.left=y.x-p.width,d.y>y.y?M.top=y.y-m:M.top=y.y-p.height+m):(d.x>y.x?M.left=y.x:M.left=y.x-p.width,d.y>y.y?M.top=y.y-m:M.top=y.y-p.height+m),t(p).css({top:M.top+"px",left:M.left+"px"}).addClass("pointer")})}};var n=function(t,e,o,i){var n=new Image,l=this.options.endPoint.radius,h={anchor:{},mid:{},end:{}},p=(o.x===e.x&&o.y!==e.y,{w:Math.ceil(Math.abs(o.x-t.x)+l+6),h:Math.ceil(Math.abs(t.y-o.y)+l+6)}),d=document.createElement("canvas");d.height=p.h,d.width=p.w;var y=d.getContext("2d");y.translate(.5,.5);var c=0;return Math.abs(o.y-t.y)<=l&&(c=l+2-Math.abs(o.y-t.y),0>c&&(c=0)),t.x>o.x?(h.anchor.x=1,h.mid.x=Math.ceil(e.x-o.x+1),h.end.x=Math.ceil(t.x-o.x+1)):(h.anchor.x=Math.ceil(p.w-1),h.mid.x=Math.ceil(p.w-(o.x-e.x)-1),h.end.x=Math.ceil(p.w-(o.x-t.x)-1)),t.y>o.y?(h.anchor.y=1,h.mid.y=Math.ceil(e.y-o.y+1),h.end.y=Math.ceil(t.y-o.y+1)):o.y>t.y&&(h.anchor.y=Math.ceil(p.h-c-1),h.mid.y=Math.ceil(h.anchor.y-(o.y-e.y)-c-1),h.end.y=Math.ceil(p.h-(o.y-t.y)-c-1)),s(y,h.anchor,h.mid,this.options.line.width,this.options.line.color),s(y,h.mid,h.end,this.options.line.width,this.options.line.color),"circle"===this.options.endPoint.style?r(y,h.end,l,this.options.endPoint.stroke,i,this.options.endPoint.strokeColor):"square"===this.options.endPoint.style&&a(y,h.end,l,this.options.endPoint.stroke,i,this.options.endPoint.strokeColor),n.src=d.toDataURL("image/png"),n},s=function(t,e,o,i,n){t.beginPath(),t.strokeStyle=n,t.lineWidth=i,t.moveTo(e.x,e.y),t.lineTo(o.x,o.y),t.stroke()},r=function(t,e,o,i,n,s){t.beginPath(),t.strokeStyle=s,t.fillStyle=n,t.lineWidth=i,t.arc(e.x,e.y,o,0,2*Math.PI,!1),i>0&&t.stroke(),t.fill()},a=function(t,e,o,i,n,s){t.beginPath(),t.strokeStyle=s,t.fillStyle=n,t.lineWidth=i,i>0&&(t.rect(e.x-o/2,e.y-o/2,o,o),t.stroke()),t.fillRect(e.x-o/2,e.y-o/2,o,o)};o.prototype.getOptions=function(e){var o,i,n;void 0!==e.line&&(o=t.extend({},this.getDefaults().line,e.line)),void 0!==e.endPoint&&(i=t.extend({},this.getDefaults().endPoint,e.endPoint)),void 0!==e.anchorPoint&&(n=t.extend({},this.getDefaults().anchorPoint,e.anchorPoint));var s=t.extend({},this.getDefaults(),this.$element.data(),e);return void 0!==o&&(s.line=o),void 0!==i&&(s.endPoint=i),void 0!==n&&(s.anchorPoint=n),s},o.prototype.getDefaults=function(){return o.DEFAULTS},o.prototype.destroy=function(){delete this.options,delete this.$element};var l=t.fn.videopointer;t.fn.videopointer=e,t.fn.videopointer.Constructor=o,t.fn.videopointer.noConflict=function(){return t.fn.videopointer=l,this}}(jQuery);