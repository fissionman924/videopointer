/**
 * @license Copyright 2016 Nathaniel Lord
 */
!function(t){"use strict";function e(e,o){return this.each(function(){var n=t(this),r=n.data("videopointer"),a="object"==typeof e&&e;r||n.data("videopointer",r=new i(this,a)),"string"==typeof e&&r[e](o)})}Math.radians=function(t){return t*Math.PI/180};var i=function(t,e){this.$element=null,this.options=null,this.init(t,e)};i.DEFAULTS={initialized:!1,endPointRadius:4,endPointStroke:2,lineColor:"#fff",line:{color:"#fff",width:2,style:"angled",angle:45},endPoint:{radius:0,stroke:0,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},anchorPoint:{radius:0,stroke:0,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},videoSelector:"video",itemSelector:".pointer-item",anchorSelector:".pointer-anchor"},i.prototype.init=function(e,i){var o=this;this.$element=t(e),this.options=this.getOptions(i),this.state={},this.generatePoints.apply(this),this.$element.on("mouseenter focus",o.options.itemSelector,function(e){var i=t(o.options.itemSelector,o.$element).index(e.currentTarget),n=o.options.points[i].time,r=t(o.options.videoSelector,o.$element)[0];return void 0===n?!1:(r.currentTime=n,void(r.paused||r.pause()))}).on("mouseleave blur",o.options.itemSelector,function(e){var i=t(o.options.videoSelector,o.$element)[0];i.paused&&i.play()}),t(window).on("resize",function(t){o.generatePoints.apply(o)}),t(o.options.videoSelector,this.$element).on("canplay",function(t){o.generatePoints.apply(o)})};var o=function(t,e){var i;if(typeof t!=typeof e)return!1;if(null===t||null===e&&t!==e)return!1;if(Array.isArray(t)){if(t.length!=e.length)return!1;for(t.sort(),e.sort(),i=0;i<t.length;i++)if(!o(t[i],e[i]))return!1}else{if("object"!=typeof t)return t===e;var n=Object.keys(t),r=Object.keys(e);if(!o(n,r))return!1;for(i=0;i<n.length;i++)if(!o(t[n[i]],e[r[i]]))return!1}return!0};i.prototype.clearImages=function(){t(".pointer",this.$element).replaceWith("")},i.prototype.rerender=function(){this.state={},this.clearImages.apply(this),this.generatePoints.apply(this)},i.prototype.generatePoints=function(){var e=this,i=(this.options.points,this.options.line.angle),c=!1,y=t(t(e.options.videoSelector,this.$element)[0]),p=a(y),u=[],x=n.apply(this);t(x,this.$element).each(function(e,i){var o=t(i),n=a(o);u.push(n)}),void 0!==e.state.vid&&void 0!==e.state.items&&o(e.state.vid,p)&&o(e.state.items,u)||(e.state.vid=p,e.state.items=u,e.clearImages.apply(e),c=!0),c&&t(x,this.$element).each(function(o,n){var c=e.options.points[o];if(void 0===c)return!1;var y=!1,u={x:0,y:0},x={x:0,y:0},f={x:0,y:0};u.x=c.x/100*p.w+p.x,u.y=c.y/100*p.h+p.y;var m=t(n),v=a(m);l(p,v)?(y=!0,v.y>p.y+p.h?x.y=v.y:x.y=v.y+v.h,x.x=v.x+v.w/2):(m.position().left>p.x+p.w?x.x=v.x:x.x=v.x+v.w,x.y=v.y+v.h/2);var g=e.options.endPoint.fillColor;void 0!==c.color&&(g=c.color),"straight"===e.options.line.style?t.extend(f,x):f=h(x,u,i,y),d.call(e,c,u,f,x,g,function(t){r.call(e,c,n,x,s(m),u,y,t)})})};var n=function(){var e=this.options.anchorSelector;return 0===t(e,this.$element).length&&(e=this.options.itemSelector),e},r=function(e,i,o,r,a,s,l){var h=this,d=t.extend(!0,{},this.options.endPoint,e.endPoint),c=t.extend(!0,{},this.options.anchorPoint,e.anchorPoint),y=(t.extend(!0,{},this.options.line,e.line),n.apply(this));h.options.itemSelector===y?t(i).append(l):t(i).parents(h.options.itemSelector).append(l),t(l).css("position","absolute");var p=1,u=1,x=d.radius>c.radius?2*d.radius:c.radius;t(l).height()<=x?p=d.radius+d.stroke-Math.abs(o.y-a.y):p+=c.radius,t(l).width()<=x?u=d.radius+d.stroke-Math.abs(o.x-a.x):u+=c.radius;var f={left:0,top:0};s?(a.x>o.x?f.left=r.x:f.left=r.x-l.width,a.y>o.y?f.top=r.y-p:f.top=r.y-l.height+p):(a.x>o.x?f.left=r.x:f.left=r.x-l.width,a.y>o.y?f.top=r.y-p+r.h/2:f.top=r.y-l.height+p+r.h/2),t(l).css({top:f.top+"px",left:f.left+"px"}).addClass("pointer")},a=function(t){var e={x:t.offset().left+parseInt(t.css("padding-left"))+parseInt(t.css("border-left-width")),y:t.offset().top+parseInt(t.css("padding-top"))+parseInt(t.css("border-top-width")),w:t.width(),h:t.height()};return e},s=function(t){var e={x:t.position().left+parseInt(t.css("padding-left"))+parseInt(t.css("border-left-width")),y:t.position().top+parseInt(t.css("padding-top"))+parseInt(t.css("border-top-width")),w:t.width(),h:t.height()};return e},l=function(t,e){var i=!1;return e.x>=t.x&&e.x<=t.x+t.w&&(e.y>t.y+t.h||e.y+e.h<t.y)&&(i=!0),i},h=function(t,e,i,o){var n={x:0,y:0},r={A:i,B:90,C:180-i-90},a={a:Math.abs(e.y-t.y),b:0,c:0};return o&&(a.a=Math.abs(e.x-t.x)),a.b=a.a*Math.sin(Math.radians(r.B))/Math.sin(Math.radians(r.A)),a.c=a.a*Math.sin(Math.radians(r.C))/Math.sin(Math.radians(r.A)),o?(e.y>t.y?n.y=e.y-a.c:n.y=e.y+a.c,Math.abs(e.y-t.y)<Math.abs(e.x-t.x)&&(n.y=e.y),n.x=t.x):(e.x>t.x?n.x=e.x-a.c:n.x=e.x+a.c,Math.abs(e.x-t.x)<Math.abs(e.y-t.y)&&(n.x=e.x),n.y=t.y),n},d=function(e,i,o,n,r,a){var s=new Image,l=this,h={anchor:{},mid:{},end:{}},d=n.x===o.x&&n.y!==o.y,p=t.extend(!0,{},this.options.endPoint,e.endPoint),u=t.extend(!0,{},this.options.anchorPoint,e.anchorPoint),m=t.extend(!0,{},this.options.line,e.line),v={w:Math.ceil(Math.abs(n.x-i.x)+p.radius+u.radius+6),h:Math.ceil(Math.abs(i.y-n.y)+p.radius+u.radius+6)},g=document.createElement("canvas");g.height=v.h,g.width=v.w;var M=g.getContext("2d");if(Math.floor(this.options.line.width)%2===1){var b=.5;i.y<n.y&&(b=-.5),M.translate(.5,b)}var w=0;if(Math.abs(n.y-i.y)<=p.radius&&(w=this.options.endPoint.radius+2-Math.abs(n.y-i.y),0>w&&(w=0)),i.x>n.x?(h.anchor.x=1+u.radius,h.mid.x=Math.ceil(o.x-n.x)+h.anchor.x,h.end.x=Math.ceil(i.x-n.x)+h.anchor.x):(h.anchor.x=Math.ceil(v.w-1-u.radius),h.mid.x=h.anchor.x-Math.ceil(n.x-o.x),h.end.x=h.anchor.x-Math.ceil(n.x-i.x)),i.y>n.y?(h.anchor.y=1+u.radius,h.mid.y=Math.ceil(o.y-n.y)+h.anchor.y,h.end.y=Math.ceil(i.y-n.y)+h.anchor.y):n.y>i.y&&(h.anchor.y=Math.ceil(v.h-w-1-u.radius),h.mid.y=h.anchor.y-Math.ceil(n.y-o.y-w),h.end.y=h.anchor.y-Math.ceil(n.y-i.y-w)),"angled"===m.style)f(M,[h.anchor,h.mid,h.end],m.width,m.color);else if("straight"===m.style)f(M,[h.anchor,h.end],m.width,m.color);else if("curved"===m.style){var k=100,P={x:0,y:0},C={x:0,y:0};h.mid.x===h.anchor.x&&h.mid.y===h.end.y?(P.x=h.anchor.x,C.y=h.end.y,k>h.mid.y&&(k=h.mid.y),Math.abs(h.mid.x-h.end.x)<k&&(k=Math.abs(h.mid.x-h.end.x)),h.anchor.y<h.end.y?P.y=h.mid.y-k:P.y=h.mid.y-k,h.anchor.x>h.end.x?C.x=h.mid.x-k:C.x=h.mid.x+k,x(M,[h.anchor,P,C,h.end],m.width,m.color,d)):h.mid.y===h.anchor.y&&h.mid.x===h.end.x?(P.y=h.anchor.y,C.x=h.end.x,k>h.mid.x&&(k=h.mid.x),Math.abs(h.mid.y-h.end.y)<k&&(k=Math.abs(h.mid.y-h.end.y)),h.anchor.x<h.end.x?P.x=h.mid.x-k:P.x=h.mid.x+k,h.anchor.y>h.end.y?C.y=h.mid.y-k:C.y=h.mid.y+k,x(M,[h.anchor,P,C,h.end],m.width,m.color,d)):x(M,[h.anchor,h.mid,h.end],m.width,m.color,d)}c.call(l,M,h.anchor,u,function(){y.call(l,M,h.end,p,function(){s.src=g.toDataURL("image/png"),a(s)})})},c=function(t,e,i,o){"circle"===i.style?m(t,e,i.radius,i.stroke,i.fillColor,i.strokeColor):"square"===i.style&&v(t,e,i.radius,i.stroke,i.fillColor,i.strokeColor),"image"===i.style&&""!==i.url?u(t,e,i.url,i.radius,o):o.call(this)},y=function(t,e,i,o){"circle"===i.style?m(t,e,i.radius,i.stroke,i.fillColor,i.strokeColor):"square"===i.style&&v(t,e,i.radius,i.stroke,i.fillColor,i.strokeColor),"image"===i.style&&""!==i.url?u(t,e,i.url,i.radius,o):o.call(this)},p=function(t){var e=!1,i=document.createElement("canvas"),o=i.getContext("2d");o.drawImage(t,1,1);try{i.toDataURL();e=!0}catch(n){console.log("The image specified for the endpoint is not a valid image for cross origin resource sharing")}return e},u=function(t,e,i,o,n){var r=document.createElement("img");r.src=i,r.crossOrigin="Anonymous",r.onload=function(){p(r)&&t.drawImage(r,e.x,e.y,o,o),n()},r.onerror=function(){console.log("Couldn't load the endpoint image. Please make sure it's hosted on your sire, is a valid cross origin image, is not located in a file path, and is accessible."),n()}},x=function(t,e,i,o,n){t.beginPath(),t.strokeStyle=o,t.lineWidth=i,t.moveTo(e[0].x,e[0].y);for(var r={x:0,y:0},a={x:0,y:0},s={x:0,y:0},l=1;l<e.length;l++)r=e[l],s=e[l-1],n?(a.x=s.x,a.y=r.y):(a.x=r.x,a.y=s.y),t.quadraticCurveTo(a.x,a.y,r.x,r.y);t.stroke()},f=function(t,e,i,o){t.beginPath(),t.strokeStyle=o,t.lineWidth=i,t.moveTo(e[0].x,e[0].y);for(var n,r=1;r<e.length;r++)n=e[r],t.lineTo(n.x,n.y);t.stroke()},m=function(t,e,i,o,n,r){t.beginPath(),t.strokeStyle=r,t.fillStyle=n,t.lineWidth=o,t.arc(e.x,e.y,i,0,2*Math.PI,!1),o>0&&t.stroke(),t.fill()},v=function(t,e,i,o,n,r){t.beginPath(),t.strokeStyle=r,t.fillStyle=n,t.lineWidth=o,o>0&&(t.rect(e.x-i,e.y-i,2*i,2*i),t.stroke()),t.fillRect(e.x-i,e.y-i,2*i,2*i)};i.prototype.getOptions=function(e){var i=t.extend(!0,{},this.getDefaults(),this.$element.data(),e);return i},i.prototype.getDefaults=function(){return i.DEFAULTS},i.prototype.destroy=function(){delete this.options,delete this.$element};var g=t.fn.videopointer;t.fn.videopointer=e,t.fn.videopointer.Constructor=i,t.fn.videopointer.noConflict=function(){return t.fn.videopointer=g,this}}(jQuery);