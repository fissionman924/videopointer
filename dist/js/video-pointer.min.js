/**
 * @license Copyright 2016 Nathaniel Lord
 */
!function(t){"use strict";function e(e,o){return this.each(function(){var n=t(this),s=n.data("videopointer"),a="object"==typeof e&&e;s||n.data("videopointer",s=new i(this,a)),"string"==typeof e&&s[e](o)})}Math.radians=function(t){return t*Math.PI/180};var i=function(t,e){this.$element=null,this.options=null,this.init(t,e)};i.DEFAULTS={initialized:!1,angle:45,endPointRadius:4,endPointStroke:2,lineColor:"#fff",videoSelector:"video",itemSelector:".pointer-item",expanderSelector:".pointer-expander"},i.prototype.init=function(e,i){var o=this;this.$element=t(e),this.options=this.getOptions(i),this.state={},this.generatePoints.apply(this),this.$element.on("mouseenter focus",o.options.itemSelector,function(e){var i=t(o.options.itemSelector,o.$element).index(e.currentTarget),n=o.options.points[i].time,s=t(o.options.videoSelector,o.$element)[0];return void 0===n?!1:(s.currentTime=n,void(s.paused||s.pause()))}).on("mouseleave blur",o.options.itemSelector,function(e){var i=t(o.options.videoSelector,o.$element)[0];i.paused&&i.play()}),t(window).on("resize",function(t){o.generatePoints.apply(o)}),t(o.options.videoSelector,this.$element).on("canplay",function(t){o.generatePoints.apply(o)})};var o=function(t,e){var i;if(typeof t!=typeof e)return!1;if(null===t||null===e&&t!==e)return!1;if(Array.isArray(t)){if(t.length!=e.length)return!1;for(t.sort(),e.sort(),i=0;i<t.length;i++)if(!o(t[i],e[i]))return!1}else{if("object"!=typeof t)return t===e;var n=Object.keys(t),s=Object.keys(e);if(!o(n,s))return!1;for(i=0;i<n.length;i++)if(!o(t[n[i]],e[s[i]]))return!1}return!0};i.prototype.clearImages=function(){t(".pointer",this.$element).replaceWith("")},i.prototype.rerender=function(){this.state={},this.clearImages.apply(this),this.generatePoints.apply(this)},i.prototype.generatePoints=function(){var e=this,i=(this.options.points,this.options.angle),s=!1,a=t(e.options.videoSelector,this.$element),r={x:a.position().left,y:a.position().top,w:a.width(),h:a.height()},p=[];if(t(e.options.expanderSelector,this.$element).each(function(e,i){var o=t(i),n={x:o.position().left,y:o.position().top,w:o.width(),h:o.outerHeight()};p.push(n)}),void 0!==e.state.vid&&void 0!==e.state.items&&o(e.state.vid,r)&&o(e.state.items,p)||(e.state.vid=r,e.state.items=p,e.clearImages.apply(e),s=!0),s){var h;t(e.options.expanderSelector,this.$element).each(function(o,s){var a=e.options.points[o];if(void 0===a)return!1;var p=!1,l={x:0,y:0},y={x:0,y:0},c={x:0,y:0};l.x=a.x/100*r.w+r.x,l.y=a.y/100*r.h+r.y;var d=t(s);y.x=d.position().left,y.y=d.position().top+d.outerHeight()/2,d.position().left>=r.x&&d.position().left<=r.x+r.w&&(d.position().top>r.y+r.h||d.position().top+d.outerHeight()<r.y)&&(p=!0);var x={A:i,B:90,C:180-i-90},u={a:Math.abs(l.y-y.y),b:0,c:0};p&&(u.a=Math.abs(l.x-y.x)),u.b=u.a*Math.sin(Math.radians(x.B))/Math.sin(Math.radians(x.A)),u.c=u.a*Math.sin(Math.radians(x.C))/Math.sin(Math.radians(x.A)),p?(l.y>y.y?c.y=l.y-u.c:c.y=l.y+u.c,Math.abs(l.y-y.y)<Math.abs(l.x-y.x)&&(c.y=l.y),c.x=y.x):(l.x>y.x?c.x=l.x-u.c:c.x=l.x+u.c,Math.abs(l.x-y.x)<Math.abs(l.y-y.y)&&(c.x=l.x),c.y=y.y),h=null,h=n.call(e,l,c,y,a.color),t(s).parents(e.options.itemSelector).append(h),t(h).css("position","absolute");var f=1;t(h).height()<=12&&(f=e.options.endPointRadius+e.options.endPointStroke-Math.abs(y.y-l.y)),l.x>y.x?t(h).css({left:y.x+"px"}):t(h).css({left:y.x-h.width+"px"}),l.y>y.y?t(h).css({top:y.y-f+"px"}):t(h).css({top:y.y-h.height+f+"px"}),t(h).addClass("pointer")})}};var n=function(t,e,i,o){var n=new Image,r=this.options.endPointRadius;e.x!==t.x&&Math.abs(e.x-t.x)!==Math.abs(e.y-t.y)&&console.log(t,e);var p={anchor:{},mid:{},end:{}},h=(i.x===e.x&&i.y!==e.y,{w:Math.ceil(Math.abs(i.x-t.x)+r+6),h:Math.ceil(Math.abs(t.y-i.y)+r+6)}),l=document.createElement("canvas");l.height=h.h,l.width=h.w;var y=l.getContext("2d"),c=0;return Math.abs(i.y-t.y)<=r&&(c=r+2-Math.abs(i.y-t.y),0>c&&(c=0)),t.x>i.x?(p.anchor.x=1,p.mid.x=e.x-i.x+1,p.end.x=t.x-i.x+1):(p.anchor.x=h.w-1,p.mid.x=h.w-(i.x-e.x)-1,p.end.x=h.w-(i.x-t.x)-1),t.y>i.y?(p.anchor.y=1,p.mid.y=1,p.end.y=t.y-e.y):i.y>t.y&&(p.anchor.y=h.h-c-1,p.mid.y=p.anchor.y-(i.y-e.y)-c-1,p.end.y=h.h-(i.y-t.y)-c-1),s(y,p.anchor,p.mid,2,this.options.lineColor),s(y,p.mid,p.end,2,this.options.lineColor),a(y,p.end,r,2,o,this.options.lineColor),n.src=l.toDataURL("image/png"),n},s=function(t,e,i,o,n){t.beginPath(),t.strokeStyle=n,t.lineWidth=o,t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke()},a=function(t,e,i,o,n,s){t.beginPath(),t.strokeStyle=s,t.fillStyle=n,t.lineWidth=o,t.arc(e.x,e.y,i,0,2*Math.PI,!1),t.stroke(),t.fill()};i.prototype.getOptions=function(e){var i=t.extend({},this.getDefaults(),this.$element.data(),e);return i},i.prototype.getDefaults=function(){return i.DEFAULTS},i.prototype.destroy=function(){delete this.options,delete this.$element};var r=t.fn.videopointer;t.fn.videopointer=e,t.fn.videopointer.Constructor=i,t.fn.videopointer.noConflict=function(){return t.fn.videopointer=r,this}}(jQuery);