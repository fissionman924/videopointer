/**
 * @license Copyright 2016 Nathaniel Lord
 */
!function(t){"use strict";function e(e,o){return this.each(function(){var n=t(this),r=n.data("videopointer"),s="object"==typeof e&&e;r||n.data("videopointer",r=new i(this,s)),"string"==typeof e&&r[e](o)})}Math.radians=function(t){return t*Math.PI/180};var i=function(t,e){this.$element=null,this.options=null,this.init(t,e)};i.DEFAULTS={initialized:!1,endPointRadius:4,endPointStroke:2,lineColor:"#fff",line:{color:"#fff",width:2,style:"angled",angle:45},endPoint:{radius:4,stroke:2,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},anchorPoint:{radius:4,stroke:2,style:"none",strokeColor:"#fff",fillColor:"#fff",url:""},videoSelector:"video",itemSelector:".pointer-item",anchorSelector:".pointer-anchor"},i.prototype.init=function(e,i){var o=this;this.$element=t(e),this.options=this.getOptions(i),this.state={},this.generatePoints.apply(this),this.$element.on("mouseenter focus",o.options.itemSelector,function(e){var i=t(o.options.itemSelector,o.$element).index(e.currentTarget),n=o.options.points[i].time,r=t(o.options.videoSelector,o.$element)[0];return void 0===n?!1:(r.currentTime=n,void(r.paused||r.pause()))}).on("mouseleave blur",o.options.itemSelector,function(e){var i=t(o.options.videoSelector,o.$element)[0];i.paused&&i.play()}),t(window).on("resize",function(t){o.generatePoints.apply(o)}),t(o.options.videoSelector,this.$element).on("canplay",function(t){o.generatePoints.apply(o)})};var o=function(t,e){var i;if(typeof t!=typeof e)return!1;if(null===t||null===e&&t!==e)return!1;if(Array.isArray(t)){if(t.length!=e.length)return!1;for(t.sort(),e.sort(),i=0;i<t.length;i++)if(!o(t[i],e[i]))return!1}else{if("object"!=typeof t)return t===e;var n=Object.keys(t),r=Object.keys(e);if(!o(n,r))return!1;for(i=0;i<n.length;i++)if(!o(t[n[i]],e[r[i]]))return!1}return!0};i.prototype.clearImages=function(){t(".pointer",this.$element).replaceWith("")},i.prototype.rerender=function(){this.state={},this.clearImages.apply(this),this.generatePoints.apply(this)},i.prototype.generatePoints=function(){var e=this,i=(this.options.points,this.options.line.angle),h=!1,l=t(e.options.videoSelector,this.$element),d=n(l),y=[],p=e.options.anchorSelector;if(0===t(p,this.$element).length&&(p=e.options.itemSelector),t(p,this.$element).each(function(e,i){var o=t(i),r=n(o);y.push(r)}),void 0!==e.state.vid&&void 0!==e.state.items&&o(e.state.vid,d)&&o(e.state.items,y)||(e.state.vid=d,e.state.items=y,e.clearImages.apply(e),h=!0),h){var c;t(p,this.$element).each(function(o,h){var l=e.options.points[o];if(void 0===l)return!1;var y=!1,x={x:0,y:0},f={x:0,y:0},u={x:0,y:0};x.x=l.x/100*d.w+d.x,x.y=l.y/100*d.h+d.y;var m=t(h),v=n(m);r(d,v)?(y=!0,m.position().top>d.y+d.h?f.y=m.position().top:f.y=m.position().top+m.outerHeight(),f.x=m.position().left+m.outerWidth()/2):(m.position().left>d.x+d.w?f.x=m.position().left:f.x=m.position().left+m.outerWidth(),f.y=m.position().top+m.outerHeight()/2);var g=e.options.endPoint.fillColor;void 0!==l.color&&(g=l.color),"straight"===e.options.line.style?t.extend(u,f):u=s(f,x,i,y),c=a.call(e,e.options.line.style,x,u,f,g),e.options.itemSelector===p?t(h).append(c):t(h).parents(e.options.itemSelector).append(c),t(c).css("position","absolute");var M=1,P=1;t(c).height()<=12&&(M=e.options.endPoint.radius+e.options.endPoint.stroke-Math.abs(f.y-x.y)),t(c).width()<=12&&(P=e.options.endPoint.radius+e.options.endPoint.stroke-Math.abs(f.x-x.x));var b={left:0,top:0};y?(x.x>f.x?b.left=f.x:b.left=f.x-c.width,x.y>f.y?b.top=f.y-M:b.top=f.y-c.height+M):(x.x>f.x?b.left=f.x:b.left=f.x-c.width,x.y>f.y?b.top=f.y-M:b.top=f.y-c.height+M),t(c).css({top:b.top+"px",left:b.left+"px"}).addClass("pointer")})}};var n=function(t){var e={x:t.position().left,y:t.position().top,w:t.outerWidth(),h:t.outerHeight()};return e},r=function(t,e){var i=!1;return e.x>=t.x&&e.x<=t.x+t.w&&(e.y>t.y+t.h||e.y+e.h<t.y)&&(i=!0),i},s=function(t,e,i,o){var n={x:0,y:0},r={A:i,B:90,C:180-i-90},s={a:Math.abs(e.y-t.y),b:0,c:0};return o&&(s.a=Math.abs(e.x-t.x)),s.b=s.a*Math.sin(Math.radians(r.B))/Math.sin(Math.radians(r.A)),s.c=s.a*Math.sin(Math.radians(r.C))/Math.sin(Math.radians(r.A)),o?(e.y>t.y?n.y=e.y-s.c:n.y=e.y+s.c,Math.abs(e.y-t.y)<Math.abs(e.x-t.x)&&(n.y=e.y),n.x=t.x):(e.x>t.x?n.x=e.x-s.c:n.x=e.x+s.c,Math.abs(e.x-t.x)<Math.abs(e.y-t.y)&&(n.x=e.x),n.y=t.y),n},a=function(t,e,i,o,n){var r=new Image,s=this.options.endPoint.radius,a={anchor:{},mid:{},end:{}},p=o.x===i.x&&o.y!==i.y,c={w:Math.ceil(Math.abs(o.x-e.x)+s+6),h:Math.ceil(Math.abs(e.y-o.y)+s+6)},x=document.createElement("canvas");x.height=c.h,x.width=c.w;var f=x.getContext("2d");if(Math.floor(this.options.line.width)%2===1){var u=.5;e.y<o.y&&(u=-.5),f.translate(.5,u)}var m=0;if(Math.abs(o.y-e.y)<=s&&(m=s+2-Math.abs(o.y-e.y),0>m&&(m=0)),e.x>o.x?(a.anchor.x=1,a.mid.x=Math.ceil(i.x-o.x+1),a.end.x=Math.ceil(e.x-o.x+1)):(a.anchor.x=Math.ceil(c.w-1),a.mid.x=Math.ceil(c.w-(o.x-i.x)-1),a.end.x=Math.ceil(c.w-(o.x-e.x)-1)),e.y>o.y?(a.anchor.y=1,a.mid.y=Math.ceil(i.y-o.y+1),a.end.y=Math.ceil(e.y-o.y+1)):o.y>e.y&&(a.anchor.y=Math.ceil(c.h-m-1),a.mid.y=Math.ceil(a.anchor.y-(o.y-i.y)-m-1),a.end.y=Math.ceil(c.h-(o.y-e.y)-m-1)),"angled"===t)l(f,[a.anchor,a.mid,a.end],this.options.line.width,this.options.line.color);else if("straight"===t)l(f,[a.anchor,a.end],this.options.line.width,this.options.line.color);else if("curved"===t){var v=100,g={x:0,y:0},M={x:0,y:0};a.mid.x===a.anchor.x&&a.mid.y===a.end.y?(g.x=a.anchor.x,M.y=a.end.y,v>a.mid.y&&(v=a.mid.y),Math.abs(a.mid.x-a.end.x)<v&&(v=Math.abs(a.mid.x-a.end.x)),a.anchor.y<a.end.y?g.y=a.mid.y-v:g.y=a.mid.y-v,a.anchor.x>a.end.x?M.x=a.mid.x-v:M.x=a.mid.x+v,h(f,[a.anchor,g,M,a.end],this.options.line.width,this.options.line.color,p)):a.mid.y===a.anchor.y&&a.mid.x===a.end.x?(g.y=a.anchor.y,M.x=a.end.x,v>a.mid.x&&(v=a.mid.x),Math.abs(a.mid.y-a.end.y)<v&&(v=Math.abs(a.mid.y-a.end.y)),a.anchor.x<a.end.x?g.x=a.mid.x-v:g.x=a.mid.x+v,a.anchor.y>a.end.y?M.y=a.mid.y-v:M.y=a.mid.y+v,h(f,[a.anchor,g,M,a.end],this.options.line.width,this.options.line.color,p)):h(f,[a.anchor,a.mid,a.end],this.options.line.width,this.options.line.color,p)}return"circle"===this.options.endPoint.style?d(f,a.end,s,this.options.endPoint.stroke,n,this.options.endPoint.strokeColor):"square"===this.options.endPoint.style&&y(f,a.end,s,this.options.endPoint.stroke,n,this.options.endPoint.strokeColor),r.src=x.toDataURL("image/png"),r},h=function(t,e,i,o,n){t.beginPath(),t.strokeStyle=o,t.lineWidth=i,t.moveTo(e[0].x,e[0].y);for(var r={x:0,y:0},s={x:0,y:0},a={x:0,y:0},h=1;h<e.length;h++)r=e[h],a=e[h-1],n?(s.x=a.x,s.y=r.y):(s.x=r.x,s.y=a.y),t.quadraticCurveTo(s.x,s.y,r.x,r.y);t.stroke()},l=function(t,e,i,o){t.beginPath(),t.strokeStyle=o,t.lineWidth=i,t.moveTo(e[0].x,e[0].y);for(var n,r=1;r<e.length;r++)n=e[r],t.lineTo(n.x,n.y);t.stroke()},d=function(t,e,i,o,n,r){t.beginPath(),t.strokeStyle=r,t.fillStyle=n,t.lineWidth=o,t.arc(e.x,e.y,i,0,2*Math.PI,!1),o>0&&t.stroke(),t.fill()},y=function(t,e,i,o,n,r){t.beginPath(),t.strokeStyle=r,t.fillStyle=n,t.lineWidth=o,o>0&&(t.rect(e.x-i/2,e.y-i/2,i,i),t.stroke()),t.fillRect(e.x-i/2,e.y-i/2,i,i)};i.prototype.getOptions=function(e){var i,o,n;void 0!==e.line&&(i=t.extend({},this.getDefaults().line,e.line)),void 0!==e.endPoint&&(o=t.extend({},this.getDefaults().endPoint,e.endPoint)),void 0!==e.anchorPoint&&(n=t.extend({},this.getDefaults().anchorPoint,e.anchorPoint));var r=t.extend({},this.getDefaults(),this.$element.data(),e);return void 0!==i&&(r.line=i),void 0!==o&&(r.endPoint=o),void 0!==n&&(r.anchorPoint=n),r},i.prototype.getDefaults=function(){return i.DEFAULTS},i.prototype.destroy=function(){delete this.options,delete this.$element};var p=t.fn.videopointer;t.fn.videopointer=e,t.fn.videopointer.Constructor=i,t.fn.videopointer.noConflict=function(){return t.fn.videopointer=p,this}}(jQuery);